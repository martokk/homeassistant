
  kitchen_lights_timer_on:
    sequence:
    - service: script.turn_off
      entity_id: script.kitchen_lights_timer_off
    - condition: or
      conditions:
      - condition: state
        entity_id: input_boolean.var_kitchen_on
        state: 'off'
    - service: script.kitchen_lights_on


  kitchen_lights_on: #### NOTE: CALLED FROM ABOVE FUNCTION (Note the name differences)
    sequence:
    - service: script.turn_on
      data_template:
        entity_id: >-

          {% if states.input_select.var_last_known_scene.state in states.input_select.array_day_scenes.attributes.options %}
            script.kitchen_lights_timer_day
          {% elif states.input_select.var_last_known_scene.state in states.input_select.array_low_light_scenes.attributes.options  %}
            script.kitchen_lights_timer_low_light
          {%else%}
            {% if states.automation.turn_off_kitch_lights_no_movement_7sec.attributes.last_triggered %}
              {% if (as_timestamp(now())-as_timestamp(states.automation.turn_off_kitch_lights_no_movement_7sec.attributes.last_triggered)) > 30  %}
                script.kitchen_lights_timer_warm
              {% else %}
                script.kitchen_lights_timer_bright_dynamic
              {% endif %}
            {%else%}
              script.kitchen_lights_timer_warm
            {%endif%}
          {%endif %}


  kitchen_lights_timer_off:
    sequence:
    - delay: >-
        {% if states.input_slider.var_kitchen_delay.state %}
          {% print "%02d:%02d:%02d" % (states.input_slider.var_kitchen_delay.state | int  // 60 // 60, states.input_slider.var_kitchen_delay.state | int  // 60 % 60, states.input_slider.var_kitchen_delay.state | int  % 60) %}
        {%else%}
          00:00:06
        {%endif%}
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_brightness
        value: '{{ states.light.kitchen_right.attributes.brightness }}'
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_color_temp
        value: '{{ states.light.kitchen_right.attributes.color_temp }}'
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_on
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_warm
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_day
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_bright_dynamic
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_bright_long
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.var_kitchen_on
    - service: script.call_last_known_scene
    - service: mqtt.publish
      data_template:
        topic: "device/kitchen/seteffect"
        payload: >
          {% for opt in states.input_select.kitchen_led_effect.attributes.options -%}
            {% if states("input_select.kitchen_led_effect") == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}


  kitchen_lights_timer_warm:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        brightness: 135
        rgb_color: [140, 140, 140]
        color_temp: 250
        transition: 0
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_delay
        value: 1
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_brightness
        value: 135
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_color_temp
        value: 250
    - delay: '00:00:07'
    - service: script.turn_on
      entity_id: script.kitchen_lights_timer_bright_long

  kitchen_lights_timer_low_light:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        brightness: 75
        rgb_color: [140, 140, 140]
        color_temp: 250
        transition: 0
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_delay
        value: 1
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_brightness
        value: 75
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_color_temp
        value: 250
    - delay: '00:00:07'
    - service: script.turn_on
      entity_id: script.kitchen_lights_timer_bright_long


  kitchen_lights_timer_day:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        brightness: 255
        rgb_color: [255, 255, 255]
        color_temp: 200
        transition: 0
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_delay
        value: 90
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_brightness
        value: 255


  kitchen_lights_timer_bright_dynamic:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        rgb_color: [255, 255, 255]
        transition: 0
      data_template:
        color_temp: >
          {% if states("input_slider.var_kitchen_color_temp") %}
            {%if states("input_slider.var_kitchen_color_temp") | int > 200 %}
              {{ states("input_slider.var_kitchen_color_temp") | int }}
            {%else%}
              200
            {%endif%}
          {%else%}
            200
          {%endif%}
        brightness: >
          {% if states("input_slider.var_kitchen_brightness") %}
            {%if states("input_slider.var_kitchen_brightness") | int > 135 %}
              {{ states("input_slider.var_kitchen_brightness") | int }}
            {%else%}
              135
            {%endif%}
          {%else%}
            135
          {%endif%}
    - delay: '00:00:01'
    - service: script.turn_on
      entity_id: script.kitchen_lights_timer_bright_long


  kitchen_lights_timer_bright_long:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
          # - light.office_led_strip
        brightness: 255
        rgb_color: [255, 255, 255]
        color_temp: 200
      data_template:
        transition: '{%if states.light.kitchen_right.attributes.brightness %}{{ (( 255 - states.light.kitchen_right.attributes.brightness | int ) / 2.2833) | int }}{%else %}45{%endif%}'
