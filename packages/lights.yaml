homeassistant:
  customize:
    script.kitchen_lights_on:
      hidden: true
    script.kitchen_lights_timer_on:
      hidden: true
    script.kitchen_lights_timer_off:
      hidden: true
    script.kitchen_lights_timer_warm:
      hidden: true
    script.kitchen_lights_timer_bright:
      hidden: true
    script.kitchen_lights_timer_bright_dynamic:
      hidden: true
    script.kitchen_lights_timer_bright_long:
      hidden: true
    script.kitchen_lights_timer_day:
      hidden: true
# switch:
light:
  - platform: lifx
# binary_sensor:
# sensor:

automation:
##########################################
########## AUTOMATIONS ###################
##########################################

  #********** Kitchen Motion ***************************************#
  - alias: turn_on_kitchen_lights_movement
    trigger:
    - platform: state
      entity_id: binary_sensor.kitchen_motion_sensor
      from: 'off'
      to: 'on'
    action:
    - service: homeassistant.turn_on
      entity_id: script.kitchen_lights_timer_on
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.var_kitchen_on

  - alias: turn_off_kitchen_lights_no_movement_7sec
    trigger:
    - platform: state
      entity_id: binary_sensor.kitchen_motion_sensor
      from: 'on'
      to: 'off'
    action:
    - service: homeassistant.turn_on
      entity_id: script.kitchen_lights_timer_off

  - alias: turn_on_kitchen_lights_sink_movement
    trigger:
      - platform: mqtt
        topic: device/kitchen/pir3
        payload: "1"
    action:
    - service: script.kitchen_lights_timer_day

  #********** Set Variables ***************************************#
  - alias: setMin_var_kitchen_delay
    trigger:
    - platform: state
      entity_id: input_boolean.var_kitchen_on
      from: "off"
      to: "on"
      for:
        seconds: 4
    action:
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_delay
        value: 6

  - alias: setMid_var_kitchen_delay
    trigger:
    - platform: state
      entity_id: input_boolean.var_kitchen_on
      state: "on"
      for:
        seconds: 30
    action:
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_delay
        value: 15

  - alias: setMax_var_kitchen_delay
    trigger:
    - platform: state
      entity_id: input_boolean.var_kitchen_on
      state: "on"
      for:
        seconds: 90
    action:
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_delay
        value: 60



  #********** Bedroom Motion ***************************************#
  # - alias: bedroom_motion_turn_on_lights
  #   trigger:
  #   - platform: state
  #     entity_id: binary_sensor.bedroom_motion_sensor
  #     from: 'off'
  #     to: 'on'
  #   action:
  #   - service: light.turn_on
  #     entity_id: light.sonoff_silver_lamp
  #   - service: input_select.select_option
  #     data:
  #       entity_id: input_select.bedroom_led_effect
  #       option: 'Static'
  #   - service: light.turn_on
  #     data:
  #       entity_id: light.bedroom_led_strip
  #       brightness: 25
  #       rgb_color: [255, 175, 125]
  #
  #
  # - alias: bedroom_motion_turn_off_lights
  #   trigger:
  #   - platform: state
  #     entity_id: binary_sensor.bedroom_motion_sensor
  #     from: 'on'
  #     to: 'off'
  #     # for:
  #     #   minutes: 5
  #   action:
  #   - service: script.call_last_known_scene



  #********** Enterainment Center Motion ***************************************#
  - alias: entertainment_center_motion_turn_on_lights
    trigger:
    - platform: state
      entity_id: binary_sensor.entertainment_center_motion_sensor
      from: 'off'
      to: 'on'
    condition:
      condition: or
      conditions:
        - condition: template
          value_template: '{% if states.input_select.var_last_known_scene.state == "Off" %} true {%endif%}'
    action:
    - service: input_select.select_option
      data:
        entity_id: input_select.entertainment_center_led_effect
        option: 'Static'
    - service: light.turn_on
      data:
        entity_id: light.entertainment_center_led_strip
        brightness: 50
        rgb_color: [150, 1, 0]
    - service: input_select.select_option
      data:
        entity_id: input_select.tables_led_effect
        option: 'Static'
    - service: light.turn_on
      data:
        entity_id: light.tables_led_strip
        brightness: 50
        rgb_color: [150, 1, 0]
    - service: light.turn_on
      data:
        entity_id: light.office_led_strip
        brightness: 50
        rgb_color: [150, 1, 0]

  - alias: entertainment_center_motion_turn_off_lights
    trigger:
    - platform: state
      entity_id: binary_sensor.entertainment_center_motion_sensor
      from: 'on'
      to: 'off'
      for:
        minutes: 5
    condition:
      condition: or
      conditions:
        - condition: template
          value_template: '{% if states.input_select.var_last_known_scene.state == "Off" %} true {%endif%}'
    action:
    - service: light.turn_off
      entity_id: light.entertainment_center_led_strip
    - service: light.turn_off
      entity_id: light.tables_led_strip
    - service: light.turn_off
      entity_id: light.office_led_strip

  #********** Set Last Known Scene ***************************************#

##########################################
############### SCENE CHANGE ###############
##########################################

  - alias: set_var_last_known_scene
    trigger:
    - platform: event
      event_type: 'call_service'
      event_data:
        service: turn_on
        domain: scene
    action:
    - condition: template
      value_template: >
        {% if trigger.event.data.service_data.entity_id[0][6:] | replace("10m_", "") | replace("0s_", "") | replace("_", " ") | title in states.input_select.var_last_known_scene.attributes.options %}
          true
        {% else %}
          false
        {% endif %}
    - service: input_select.select_option
      data_template:
        entity_id: input_select.var_last_known_scene
        option: '{{ trigger.event.data.service_data.entity_id[0][6:] | replace("10m_", "") | replace("0s_", "") | replace("_", " ") | title }}'
    - condition: state
      entity_id: input_boolean.var_kitchen_on
      state: 'on'
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_brightness
        value: '{{ states.light.kitchen_right.attributes.brightness }}'
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_color_temp
        value: '{{ states.light.kitchen_right.attributes.color_temp }}'

  - alias: set_var_last_known_scene2
    trigger:
    - platform: event
      event_type: 'call_service'
      event_data:
        service: turn_on
        domain: scene
    action:
    - condition: template
      value_template: >
        {% if trigger.event.data.service_data.entity_id[6:] | replace("10m_", "") | replace("0s_", "") | replace("_", " ") | title in states.input_select.var_last_known_scene.attributes.options  %}
          true
        {% else %}
          false
        {% endif %}
    - service: input_select.select_option
      data_template:
        entity_id: input_select.var_last_known_scene
        option: '{{ trigger.event.data.service_data.entity_id[6:] | replace("10m_", "") | replace("0s_", "") | replace("_", " ") | title }}'
    - condition: state
      entity_id: input_boolean.var_kitchen_on
      state: 'on'
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_brightness
        value: '{{ states.light.kitchen_right.attributes.brightness }}'
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_color_temp
        value: '{{ states.light.kitchen_right.attributes.color_temp }}'

  - alias: set_var_last_known_scene_to_off
    trigger:
    - platform: state
      entity_id: group.all_lights
      state: 'off'
    action:
    - service: input_select.select_option
      data:
        entity_id: input_select.var_last_known_scene
        option: 'Off'

##########################################
########## SCRIPTS #######################
##########################################
script:
  #********** SceneGen ***************************************#
  # scenegen:
  #   alias: "SceneGen: Save Scene"
  #   sequence:
  #   - service: shell_command.scenegen



  #********** Call Last Known Scene ***************************************#
  call_lks_kitchen:
    sequence:
    - condition: state
      entity_id: input_boolean.var_kitchen_on
      state: 'on'
    - service: script.kitchen_lights_on

  call_lks_bedroom:
    sequence:
    - condition: state
      entity_id: input_boolean.var_bedroom_on
      state: 'on'
    - service: switch.turn_on
      entity_id: switch.sonoff_silver_lamp

  call_last_known_scene:
    sequence:
    - service: scene.turn_on
      data_template:
        entity_id: 'scene.{{ states("input_select.var_last_known_scene") | replace(" ", "_") | lower }}'
    - service: script.call_last_known_led_scene
    - service: script.call_lks_kitchen
    - service: script.call_lks_bedroom


  call_last_known_scene_0s:
    sequence:
    - service: scene.turn_on
      data_template:
        entity_id: 'scene.0s_{{ states("input_select.var_last_known_scene") | replace(" ", "_") | lower }}'
    - delay: "00:00:00"
    - service: script.call_last_known_led_scene
    - service: script.call_lks_kitchen
    - service: script.call_lks_bedroom



  call_last_known_led_scene:
    sequence:
    - service: mqtt.publish
      data_template:
        topic: "device/office/led1/effect"
        payload: >
          {% for opt in states.input_select.office_led_effect.attributes.options -%}
            {% if states.input_select.office_led_effect.state | string == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}

    - service: mqtt.publish
      data_template:
        topic: "device/kitchen/led1/effect"
        payload: >
          {% for opt in states.input_select.kitchen_led_effect.attributes.options -%}
            {% if states.input_select.kitchen_led_effect.state | string == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}

    - service: mqtt.publish
      data_template:
        topic: "device/tables/led1/effect"
        payload: >
          {% for opt in states.input_select.tables_led_effect.attributes.options -%}
            {% if states.input_select.tables_led_effect.state | string == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}

    - service: mqtt.publish
      data_template:
        topic: "device/entertainment_center/led1/effect"
        payload: >
          {% for opt in states.input_select.entertainment_center_led_effect.attributes.options -%}
            {% if states.input_select.entertainment_center_led_effect.state | string == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}

    - service: mqtt.publish
      data_template:
        topic: "device/bedroom/led1/effect"
        payload: >
          {% for opt in states.input_select.bedroom_led_effect.attributes.options -%}
            {% if states.input_select.bedroom_led_effect.state | string == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}



  #**********  Kitchen Motion Lights ***************************************#
  kitchen_lights_timer_on:
    sequence:
    - service: script.turn_off
      entity_id: script.kitchen_lights_timer_off
    - service: script.kitchen_lights_on


  kitchen_lights_on: #### NOTE: CALLED FROM ABOVE FUNCTION (Note the name differences)
    sequence:
    - service: script.turn_on
      data_template:
        entity_id: >-

          {% if states.input_select.var_last_known_scene.state in states.input_select.array_day_scenes.attributes.options %}
            script.kitchen_lights_timer_day
          {% elif states.input_select.var_last_known_scene.state in states.input_select.array_low_light_scenes.attributes.options  %}
            script.kitchen_lights_timer_low_light
          {%else%}
            {% if states.automation.turn_off_kitchen_lights_no_movement_7sec.attributes.last_triggered %}
              {% if (as_timestamp(now())-as_timestamp(states.automation.turn_off_kitchen_lights_no_movement_7sec.attributes.last_triggered)) > 30  %}
                script.kitchen_lights_timer_warm
              {% else %}
                script.kitchen_lights_timer_bright_dynamic
              {% endif %}
            {%else%}
              script.kitchen_lights_timer_warm
            {%endif%}
          {%endif %}


  kitchen_lights_timer_off:
    sequence:
    - delay: >-
        {% if states.input_slider.var_kitchen_delay.state | int > 6 %}
          {% print "%02d:%02d:%02d" % (states.input_slider.var_kitchen_delay.state | int  // 60 // 60, states.input_slider.var_kitchen_delay.state | int  // 60 % 60, states.input_slider.var_kitchen_delay.state | int  % 60) %}
        {%else%}
          00:00:06
        {%endif%}
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_brightness
        value: '{{ states.light.kitchen_right.attributes.brightness }}'
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_color_temp
        value: '{{ states.light.kitchen_right.attributes.color_temp }}'
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_on
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_warm
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_day
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_bright_dynamic
    - service: script.turn_off
      data:
        entity_id: script.kitchen_lights_timer_bright_long
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.var_kitchen_on
    - service: script.call_last_known_scene
    - service: mqtt.publish
      data_template:
        topic: "device/kitchen/seteffect"
        payload: >
          {% for opt in states.input_select.kitchen_led_effect.attributes.options -%}
            {% if states("input_select.kitchen_led_effect") == opt %}
              {{loop.index - 1}}
            {%endif%}
          {%- endfor -%}


  kitchen_lights_timer_warm:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        brightness: 135
        rgb_color: [140, 140, 140]
        color_temp: 250
        transition: 0
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_delay
        value: 1
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_brightness
        value: 135
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_color_temp
        value: 250
    - delay: '00:00:07'
    - service: script.turn_on
      entity_id: script.kitchen_lights_timer_bright_long

  kitchen_lights_timer_low_light:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        brightness: 100
        rgb_color: [140, 140, 140]
        color_temp: 250
        transition: 0
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_delay
        value: 1
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_brightness
        value: 100
    - service: input_slider.select_value
      data:
        entity_id: input_slider.var_kitchen_color_temp
        value: 250
    - delay: '00:00:03'
    - service: script.turn_on
      entity_id: script.kitchen_lights_timer_bright_long


  kitchen_lights_timer_day:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        brightness: 255
        rgb_color: [255, 255, 255]
        color_temp: 200
        transition: 1
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_delay
        value: 50
    - service: input_slider.select_value
      data_template:
        entity_id: input_slider.var_kitchen_brightness
        value: 255


  kitchen_lights_timer_bright_dynamic:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
        rgb_color: [255, 255, 255]
        transition: 0
      data_template:
        color_temp: >
          {% if states("input_slider.var_kitchen_color_temp") %}
            {%if states("input_slider.var_kitchen_color_temp") | int > 200 %}
              {{ states("input_slider.var_kitchen_color_temp") | int }}
            {%else%}
              200
            {%endif%}
          {%else%}
            200
          {%endif%}
        brightness: >
          {% if states("input_slider.var_kitchen_brightness") %}
            {%if states("input_slider.var_kitchen_brightness") | int > 135 %}
              {{ states("input_slider.var_kitchen_brightness") | int }}
            {%else%}
              135
            {%endif%}
          {%else%}
            135
          {%endif%}
    - delay: '00:00:01'
    - service: script.turn_on
      entity_id: script.kitchen_lights_timer_bright_long


  kitchen_lights_timer_bright_long:
    sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.kitchen_left
          - light.kitchen_right
          # - light.office_led_strip
        brightness: 255
        rgb_color: [255, 255, 255]
        color_temp: 200
      data_template:
        transition: '{%if states.light.kitchen_right.attributes.brightness %}{{ (( 255 - states.light.kitchen_right.attributes.brightness | int ) / 2.2833) | int }}{%else %}45{%endif%}'



##########################################
########## STORED VARIABLES ##############
##########################################
input_boolean:
  var_kitchen_on:
  var_bedroom_on:


input_slider:
  var_kitchen_delay: #in Seconds
    initial: 7
    min: 1
    max: 900
    step: 1

  var_kitchen_brightness: #in Seconds
    min: 1
    max: 255
    step: 1

  var_kitchen_color_temp: #in Seconds
    min: 1
    max: 1000
    step: 1


input_select:
  var_last_known_scene:
    options:
      - "Chill"
      - "Chill 2"
      - "Day"
      - "Day Le"
      - "Day Bright"
      - "Night Blue"
      - "Night Cyan"
      - "Night Red"
      - "Night"
      - "Night Computer"
      - "Night Computer Red"
      - "Off"

  var_last_known_scene_helper:
    options:
      - "Chill"
      - "Chill 2"
      - "Day"
      - "Day Le"
      - "Day Bright"
      - "Night Blue"
      - "Night Cyan"
      - "Night Red"
      - "Night"
      - "Night Computer"
      - "Night Computer Red"
      - "Off"


##########################################
########## STORED ARRAYS #################
##########################################
  array_low_light_scenes:
    options:
      - "Night Red"
      - "Night Computer"
      - "Night Computer Red"
      - "Off"

  array_day_scenes:
    options:
      - "Day"
      - "Day Le"
      - "Day Bright"


##########################################
############### GROUPS ###################
##########################################
group:
  automation_lights:
    entities:
      - automation.turn_on_kitchen_lights_movement
      - automation.turn_off_kitchen_lights_no_movement_7sec
      - automation.turn_on_kitchen_lights_sink_movement
      - automation.setMin_var_kitchen_delay
      - automation.setMid_var_kitchen_delay
      - automation.setMax_var_kitchen_delay
      - automation.bedroom_motion_turn_on_lights
      - automation.bedroom_motion_turn_off_lights
      - automation.entertainment_center_motion_turn_on_lights
      - automation.entertainment_center_motion_turn_off_lights
      - automation.set_var_last_known_scene
      - automation.set_var_last_known_scene2
      - automation.set_var_last_known_scene_to_off

  script_lights:
    entities:
      - script.call_lks_kitchen
      - script.call_lks_bedroom
      - script.call_last_known_scene
      - script.call_last_known_scene_0s
      - script.call_last_known_led_scene
      - script.kitchen_lights_timer_on
      - script.kitchen_lights_on
      - script.kitchen_lights_timer_off
      - script.kitchen_lights_timer_warm
      - script.kitchen_lights_timer_low_light
      - script.kitchen_lights_timer_day
      - script.kitchen_lights_timer_bright_dynamic
      - script.kitchen_lights_timer_bright_long
