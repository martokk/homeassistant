homeassistant:
  customize:
    device_tracker.ipad:
      hidden: true
    device_tracker.dans_iphone6:
      hidden: true
    input_boolean.var_mike_home:
      emulated_hue: true
      emulated_hue_name: "Mike's Home"
    input_boolean.var_dan_home:
      emulated_hue: true
      emulated_hue_name: "Dan's Home"


automation:
##########################################
########## NOTIFICATIONS #################
##########################################

  #********** Resident Mike Home ***************************************#
  - alias: mike_home_theme_video
    trigger:
      - platform: state
        entity_id: input_boolean.var_mike_home
        from: 'off'
        to: 'on'
    action:
      # TODO: If TV off, turn on, add in delays (as seen below). If TV already on, then don't use delays. Delays are nessesary since the TV needs to cold boot and takes about 16-17 seconds to cold boot.
    - service: switch.turn_on
      entity_id: switch.sonoff_entertainment_center

    - delay: "00:00:10" ## Delay is for waiting on TV to fully turn on
    - service: script.set_entertainment_center_tv_volume
      data:
        volume_level: 20

    - service: script.notify2
      data_template:
        tts_entity_id: group.tts_devices
        tts_sound: 'intercom_ds9.mp3'
        tts_message: "Welcome home Mike!"
    - delay: "00:00:07" ## Delay is for waiting on TV to fully turn on

    - service: script.notify2
      data_template:
        chromecast_entity_id: media_player.vtv_chromecast
        chromecast_link: http://192.168.1.3:8123/local/battlestar_galactica_intro.mp4

  #********** Resident Dan Home ***************************************#
  # - alias: dan_home_theme_video
  #   trigger:
  #     - platform: state
  #       entity_id: input_boolean.var_dan_home
  #       from: 'off'
  #       to: 'on'
  #   action:
  #   - delay: "00:00:03"
  #   - service: script.notify2
  #     data_template:
  #       chromecast_entity_id: media_player.vtv_chromecast
  #       chromecast_link: http://192.168.1.3:8123/local/bushes_of_love.mp4
  #       tts_entity_id: group.tts_devices
  #       tts_sound: 'intercom_ds9.mp3'
  #       tts_message: "Welcome home Dan!"

  #********** Temp Dan Home ***************************************#
  - alias: dan_home_notification
    trigger:
    - platform: state
      entity_id: input_boolean.var_dan_home
      from: "off"
      to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.var_mike_home
        state: 'on'
    action:
    - service: script.notify2
      data_template:
        telegram_message: |
          Dan's Here!
    - condition: template
      value_template: >
        {% if states.automation.dan_home_notification.attributes.last_triggered %}
          {% if (as_timestamp(now())-as_timestamp(states.automation.dan_home_notification.attributes.last_triggered)) > (8 * 60 * 60)  %}
            true
          {% endif %}
        {%else%}
          true
        {%endif%}
    - service: script.set_entertainment_center_tv_volume
      data:
        volume_level: 18
    - service: script.notify2
      data_template:
        flood_color: "green"
        entity_id: group.ambient_lights
        delay: "00:00:04"
        tts_entity_id: group.tts_devices
        tts_sound: 'intercom_tos.mp3'
        tts_message: "Dan's is here!"
    - delay: "00:00:05"
    - service: script.notify2
      data_template:
        chromecast_entity_id: media_player.vtv_chromecast
        chromecast_link: http://192.168.1.3:8123/local/bushes_of_love.mp4



  - alias: dan_here_filler_task_reminder
    trigger:
      - platform: time
        at: '22:00:00'
    condition:
      - condition: state
        entity_id: input_boolean.var_dan_home
        state: 'on'
      - condition: state
        entity_id: input_boolean.var_mike_home
        state: 'on'
    action:
      - service: script.notify2
        data_template:
          telegram_message: "REMINDER: Do 5m Filler Tasks"



  - alias: dan_home_start_smoke_session
    trigger:
    - platform: state
      entity_id: input_boolean.var_dan_home
      from: "off"
      to: "on"
      for:
        minutes: 25
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.var_smoke_session_on
      - delay: '00:30:00'
      - service: input_boolean.turn_off
        entity_id: input_boolean.var_smoke_session_on
      - delay: '02:30:00'
      - service: input_boolean.turn_on
        entity_id: input_boolean.var_smoke_session_on
      - delay: '00:30:00'
      - service: input_boolean.turn_off
        entity_id: input_boolean.var_smoke_session_on

##########################################
########## AUTOMATIONS ###################
##########################################

  #********** User Presence ***********#
  - alias: all_residents_away_automations
    trigger:
      - platform: state
        entity_id: group.residents
        from: 'on'
        to: 'off'
        for:
          minutes: 10
    action:
    - service: script.scene2
      data:
        rooms: 'all'
        scene_name: 'off'
        transition: 600
    - service: homeassistant.turn_off
      entity_id: input_boolean.option_notify2_tts
    - service: homeassistant.turn_off
      entity_id: input_boolean.option_notify2_chromecast
    - service: homeassistant.turn_off
      entity_id: input_boolean.option_notify2_lights

  - alias: any_resident_home_automation
    trigger:
      - platform: state
        entity_id: group.residents
        from: 'off'
        to: 'on'
    action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.option_notify2_tts
    - service: homeassistant.turn_on
      entity_id: input_boolean.option_notify2_chromecast
    - service: homeassistant.turn_on
      entity_id: input_boolean.option_notify2_lights
    - service: script.scene2
      data:
        rooms: 'all'
        scene_name: 'day_bright'
        transition: 1
    - delay: "00:05:00"
    - service: script.scene2
      data_template:
        rooms: 'all'
        scene_name: '{{ states.input_select.var_lks_timebased.state }}'
        transition: 5

##########################################
########## ALARM ###################
##########################################
  - alias: motion_detected_no_resident_home
    trigger:
    - platform: state
      entity_id: binary_sensor.entertainment_center_motion_sensor
      from: 'off'
      to: 'on'
    condition:
      - condition: state
        entity_id: group.residents
        state: "off"
    action:
      - service: script.notify2
        data_template:
          telegram_message: |
            *ALERT!* Motion Detected! No Residents are home!!
            *debug_informtion:*
            {{ trigger.entity_id }} = {{ trigger.to_state.state }}
            group.residents = {{ states.group.residents.state }}


input_boolean:
##########################################
########## STORED VARIABLES ##############
##########################################
  var_mike_home:
    icon: mdi:cellphone-iphone

  var_dan_home:
    icon: mdi:cellphone-iphone


##########################################
############### GROUPS ###################
##########################################
group:

  residents:
    name: "Residents"
    entities:
    - input_boolean.var_mike_home
    - input_boolean.var_dan_home

  automation_user_presence:
    entities:
      - automation.mike_home_theme_video
      - automation.dan_home_theme_video
      - automation.dan_home_notification
      - automation.dan_here_filler_task_reminder
      - automation.dan_home_start_smoke_session
      - automation.all_residents_away_automations
      - automation.any_resident_home_automation
      - automation.motion_detected_no_resident_home

  # script_user_presence:
  #   entities:
